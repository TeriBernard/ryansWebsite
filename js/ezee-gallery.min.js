//Holds info for all slideshows
const initializedSlideshows = [
    /*{
        elem: slideShowElement
        current: 1,
        allImgs: [],
        navDots
    },*/
];
//Automates building galleries and slideshows.
window.addEventListener('DOMContentLoaded', initStuff);

function initStuff(){
    const slideshows = [...document.getElementsByClassName('ezee-slideshow')];
    //Check for slideshows and initialize
    if(slideshows.length>0){
        for(let s = 0; s< slideshows.length; s++){
            createGallery(slideshows[s]);
        }
    }

    //Galleries have to be initialized after slideshows
    const galleries = [...document.getElementsByClassName('ezee-gallery')];
    //Check for galleries and initialize
    if(galleries.length>0){
        for(let g = 0; g< galleries.length; g++){
            createGallery(galleries[g], true);
        }
    }
}

function createGallery(galleryElem, isLightbox){
    if(galleryElem){
        //If an id was passed in, use it to retrieve element
        if(typeof galleryElem === "string"){ galleryElem = document.getElementById(galleryElem); }

        galleryElem.className += " gallery-block";
        
        //Capture info of new slideshow
        let newSliderInfo = {
            el : '',
            current: 1,
            allImgs: [],
            navDots: []
        }

        //If options were passed in, check for custom wrap class
        const galleryImgWrapClass = 'ezee-gallery-img-wrapper';
    
        let newSlideshow = galleryElem;
        if(isLightbox){
            //New lightbox slideshow div
            newSlideshow = document.createElement('div');
            newSlideshow.className += " ezee-lightbox-slideshow";
            newSlideshow.style.display = "none";
        }
        

        //Create div to wrap nav dots
        let navDots = document.createElement('div');
        navDots.className += " dot-nav";
        
        //Captures what will be the index of slideshow being built
        let slideshowIndex = initializedSlideshows.length + 1;

        //Create next/prev arrows
        let nextBtn = document.createElement('a');
        nextBtn.className += " next-slide-btn";
        nextBtn.innerHTML = "&#10095;";
        nextBtn.addEventListener('click', ()=>{
            navSlides(slideshowIndex, 1);
        });
        let prevBtn = document.createElement('a');
        prevBtn.className += " prev-slide-btn";
        prevBtn.innerHTML = "&#10094;";
        prevBtn.addEventListener('click', ()=>{
            navSlides(slideshowIndex, -1);
        });
        newSlideshow.appendChild(prevBtn);
        newSlideshow.appendChild(nextBtn);
        
        //Block of lightbox slideshow images
        let slideImgBlock = document.createElement('div');
        slideImgBlock.className = " slideshow-img-block";

        //Capture all img elements in gallery element,
        //spread them into an array for iteration                
        let images = [...galleryElem.getElementsByTagName('img')];
        for(var imgIndex = 0; imgIndex<images.length; imgIndex++){
            let img = images[imgIndex];
            let galleryIndex = imgIndex + 1;
            
            //Wrap images in slideshow-styling div's
            const newSlide = document.createElement('div');
            newSlide.className += " slideshow-slide" + " slide-effect-fade";
            newSlide.appendChild(img);

            //Create new nav dot for new image
            const newDot = document.createElement('span');
            newDot.className += " slideshow-dot";
            newDot.addEventListener('click', ()=>{
                let showIndex = slideshowIndex;
                let imgNumber = (imgIndex + 1);
                showSlide(showIndex, galleryIndex);
            });


            
            newSliderInfo['allImgs'].push(newSlide);
            newSliderInfo['navDots'].push(newDot);

            slideImgBlock.appendChild(newSlide);
            navDots.appendChild(newDot);

            //***Haven't used this, but append picture type class for styles            
            let h = img.height;
            let w = img.width;
            if(h > w){ img.className += " portrait-img"; }
            else { img.className += ' landscape-img'; }

            if(isLightbox){
                //*****Create a new anchor element to take the place of img element
                const newGalleryImg = document.createElement('a');
                
                newGalleryImg.setAttribute('href', '#');
                newGalleryImg.className += " gallery-img";
                                //Set css background-img to img tag 'src'
                const imgSrc = img.getAttribute('src');
                newGalleryImg.style.backgroundImage = "url('" + imgSrc + "')";
                newGalleryImg.addEventListener('click', (e)=>{
                    e.preventDefault();
                    showLightbox(slideshowIndex, galleryIndex)
                })

                //Appends replacement anchor to original gallery element
                galleryElem.appendChild(newGalleryImg);
            }   
        }
        //Add all created slideshow parts
        newSlideshow.appendChild(slideImgBlock);
        newSlideshow.appendChild(navDots);

        //Holds reference to html element
        newSliderInfo['el'] = newSlideshow;
        //Push info onto list of made slideshows
        initializedSlideshows.push(newSliderInfo);

        if(isLightbox){
            getOverlay().appendChild(newSlideshow);
        } else {
            showSlide(slideshowIndex, 1);
        }
    
    } else {
        throw Error('No galleryElem');
    }
}


function getOverlay(lightboxID, imgArray, rootPath){
    let overlayCheck = document.getElementById('ezee-overlay');
    if(!overlayCheck){
        const body = document.getElementsByTagName('body')[0];
        overlayCheck = document.createElement('div');
        overlayCheck.id = 'ezee-overlay'
        overlayCheck.className += " ezee-lightbox-overlay";
        overlayCheck.style.display = "none";

        const closeBtn = document.createElement('a');
        closeBtn.className += ' close-lightbox-btn';
        closeBtn.innerHTML = "<span class='fa fa-times'></span>"
        closeBtn.addEventListener('click', closeLightbox);
        overlayCheck.appendChild(closeBtn);
        body.appendChild(overlayCheck); 
    }
    return overlayCheck;
}


function navSlides(sliderIndex, direction){
    //Takes either +1 or -1 int for 'direction'
    const slideshow = initializedSlideshows[sliderIndex-1];
    showSlide(sliderIndex, slideshow.current + direction)
}

function showSlide(sliderIndex, imgIndex){
    //Sets corresponding style of image to 'block

    //First sets all images to be invisible
    const slideshow = initializedSlideshows[(sliderIndex-1)];
    for(let s = 0; s < slideshow.allImgs.length; s++){
        let img = slideshow.allImgs[s];
        img.style.display = 'none';
    }

    //Checks number passed in, setting final index accordingly 
    let showImg;
    if(imgIndex < 1){showImg = (slideshow.allImgs.length - 1);}
    else if(imgIndex > slideshow.allImgs.length){showImg = 0; }
    else { showImg = (imgIndex -1) }
    
    //Get html reference from list and sets style to be visible
    slideshow.allImgs[showImg].style.display = "flex";


    const dots = slideshow.navDots;
    //Removes 'active-dot' class from all dots
    if(dots.length > 0){
        for(let q=0; q<dots.length; q++){
            dots[q].className = dots[q].className.replace(" active-dot", "");
        }
        //Sets ' active-dot' on the index relative to img
        dots[showImg].className += " active-dot";
    }

    slideshow.current = showImg +1;
}

function showLightbox(sliderIndex, imgIndex){
    let overlay = document.getElementById('ezee-overlay');
    //Hide all slideshows in lightbox
    let lightboxSlideshows = [...overlay.getElementsByClassName('ezee-lightbox-slideshow')];
    for(let q = 0; q<lightboxSlideshows.length; q++){
        lightboxSlideshows[q].style.display = "none";
    }
    initializedSlideshows[sliderIndex -1].el.style.display = "block";
    if(overlay && overlay.style.display != "block"){ overlay.style.display = 'block'; }
    showSlide(sliderIndex, imgIndex);
}

function closeLightbox(){
    let overlay = document.getElementById('ezee-overlay');
    overlay.style.display = 'none';
}
